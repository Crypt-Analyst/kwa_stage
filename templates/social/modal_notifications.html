<!-- Modal Notifications Content -->
<div class="modal-notifications-container">
    <!-- Notifications Header -->
    <div class="notifications-header d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">
            <i class="fas fa-bell"></i> Notifications
            {% if unread_count > 0 %}
                <span class="badge bg-danger">{{ unread_count }}</span>
            {% endif %}
        </h5>
        {% if unread_count > 0 %}
        <button class="btn btn-outline-primary btn-sm" onclick="markAllAsRead()">
            <i class="fas fa-check"></i> Mark all as read
        </button>
        {% endif %}
    </div>

    <!-- Notifications List -->
    <div class="notifications-list">
        {% for notification in notifications %}
        <div class="notification-item {% if not notification.is_read %}unread{% endif %}" data-id="{{ notification.id }}">
            <div class="notification-content d-flex align-items-start">
                <!-- Sender Avatar -->
                <div class="notification-avatar me-3">
                    {% if notification.sender.profile_photo %}
                        <img src="{{ notification.sender.profile_photo.url }}" alt="{{ notification.sender.user.get_full_name }}">
                    {% else %}
                        <div class="avatar-placeholder">
                            <i class="fas fa-user"></i>
                        </div>
                    {% endif %}
                </div>

                <!-- Notification Details -->
                <div class="notification-details flex-grow-1">
                    <div class="notification-message">
                        <strong>{{ notification.sender.user.get_full_name }}</strong>
                        {% if notification.notification_type == 'like' %}
                            liked your post
                        {% elif notification.notification_type == 'comment' %}
                            commented on your post
                        {% elif notification.notification_type == 'friend_request' %}
                            sent you a friend request
                        {% elif notification.notification_type == 'friend_accepted' %}
                            accepted your friend request
                        {% elif notification.notification_type == 'message' %}
                            sent you a message
                        {% elif notification.notification_type == 'mention' %}
                            mentioned you in a post
                        {% else %}
                            {{ notification.message }}
                        {% endif %}
                    </div>
                    
                    {% if notification.post %}
                    <div class="notification-preview mt-2">
                        <small class="text-muted">
                            "{{ notification.post.content|truncatechars:50 }}"
                        </small>
                    </div>
                    {% endif %}
                    
                    <div class="notification-meta d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">{{ notification.created_at|timesince }} ago</small>
                        <div class="notification-actions">
                            {% if notification.notification_type == 'friend_request' and not notification.is_read %}
                            <button class="btn btn-success btn-sm me-1" onclick="respondToFriendRequest({{ notification.id }}, 'accept')">
                                Accept
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="respondToFriendRequest({{ notification.id }}, 'decline')">
                                Decline
                            </button>
                            {% elif notification.post %}
                            <button class="btn btn-outline-primary btn-sm" onclick="viewPost({{ notification.post.id }})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            {% elif notification.group %}
                            <button class="btn btn-outline-primary btn-sm" onclick="openChat({{ notification.group.id }})">
                                <i class="fas fa-comment"></i> Open Chat
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Unread Indicator -->
                {% if not notification.is_read %}
                <div class="unread-indicator"></div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="empty-state text-center py-5">
            <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
            <h5>No notifications</h5>
            <p class="text-muted">You're all caught up! Notifications will appear here when you have new activity.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if notifications.has_other_pages %}
    <div class="pagination-container text-center mt-4">
        <nav aria-label="Notifications pagination">
            <ul class="pagination justify-content-center">
                {% if notifications.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadNotificationsPage({{ notifications.previous_page_number }})">Previous</a>
                    </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">Page {{ notifications.number }} of {{ notifications.paginator.num_pages }}</span>
                </li>
                
                {% if notifications.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadNotificationsPage({{ notifications.next_page_number }})">Next</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<style>
.modal-notifications-container {
    max-height: 70vh;
    overflow-y: auto;
}

.notification-item {
    padding: 1rem;
    border-bottom: 1px solid #eee;
    transition: background-color 0.3s;
}

.notification-item:hover {
    background-color: #f8f9fa;
}

.notification-item.unread {
    background-color: #f0f8ff;
    border-left: 4px solid var(--primary-color);
}

.notification-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    overflow: hidden;
    background: var(--light-color);
}

.notification-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--dark-color);
}

.notification-message {
    font-size: 0.95rem;
    line-height: 1.4;
}

.notification-preview {
    background: #f8f9fa;
    padding: 0.5rem;
    border-radius: 8px;
    border-left: 3px solid var(--primary-color);
}

.unread-indicator {
    width: 12px;
    height: 12px;
    background: var(--primary-color);
    border-radius: 50%;
    margin-left: 1rem;
}

.notification-actions .btn {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

.empty-state {
    background: #f8f9fa;
    border-radius: 12px;
    margin: 2rem 0;
    padding: 3rem 2rem;
}

.notifications-header {
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
}
</style>

<script>
// Notifications-specific JavaScript
function markAllAsRead() {
    fetch('{% url "social:notifications" %}?mark_read=1', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove unread styling from all notifications
            document.querySelectorAll('.notification-item.unread').forEach(item => {
                item.classList.remove('unread');
                const indicator = item.querySelector('.unread-indicator');
                if (indicator) {
                    indicator.remove();
                }
            });
            
            // Update header
            const badge = document.querySelector('.notifications-header .badge');
            if (badge) {
                badge.remove();
            }
            
            // Remove mark all as read button
            const markAllBtn = document.querySelector('button[onclick="markAllAsRead()"]').parentElement;
            if (markAllBtn) {
                markAllBtn.remove();
            }
            
            showToast('All notifications marked as read', 'success');
        }
    });
}

function respondToFriendRequest(notificationId, action) {
    // Find the notification to get the friend request details
    const notificationItem = document.querySelector(`[data-id="${notificationId}"]`);
    
    fetch(`/social/friends/respond/${notificationId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update notification
            const actionsDiv = notificationItem.querySelector('.notification-actions');
            actionsDiv.innerHTML = `<small class="text-muted">${action === 'accept' ? 'Accepted' : 'Declined'}</small>`;
            
            // Mark as read
            notificationItem.classList.remove('unread');
            const indicator = notificationItem.querySelector('.unread-indicator');
            if (indicator) {
                indicator.remove();
            }
            
            showToast(action === 'accept' ? 'Friend request accepted!' : 'Friend request declined', 'success');
        } else {
            showToast(data.message || 'Error processing request', 'error');
        }
    });
}

function viewPost(postId) {
    // Close notifications modal and open feed modal at specific post
    document.getElementById('notificationsModal').querySelector('.btn-close').click();
    
    // Open feed modal and scroll to post
    loadModalContent('feedModal', '{% url "social:feed" %}')
        .then(() => {
            const postElement = document.querySelector(`[data-post-id="${postId}"]`);
            if (postElement) {
                postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                postElement.style.background = '#fff3cd';
                setTimeout(() => {
                    postElement.style.background = '';
                }, 2000);
            }
        });
}

function openChat(chatId) {
    // Close notifications modal and open chat
    document.getElementById('notificationsModal').querySelector('.btn-close').click();
    openChatModal(chatId);
}

function loadNotificationsPage(pageNumber) {
    const url = new URL(window.location.href);
    url.searchParams.set('page', pageNumber);
    url.searchParams.set('modal', '1');
    
    fetch(url.toString())
        .then(response => response.text())
        .then(html => {
            document.getElementById('notificationsModalBody').innerHTML = html;
        });
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
